<!DOCTYPE html>
<meta charset="utf-8">
<style>
  /* Set the css */
  .axis {
    font: 14px sans-serif;
  }

  .line {
    fill: none;
    stroke: steelblue;
    stroke-width: 2px;
  }
</style>
<!-- load the d3.js library -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"
integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"
integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous">
</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"
integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous">
</script>


<!-- Load d3.js -->
<!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->
<script src="https://d3js.org/d3.v4.js"></script>

<body class="container">

    <h5 class="card-title" style="margin-top: 3%; margin-bottom: 3%;">Bitcoin marketcap simulation :</h5>

    <div class="row">
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">Marketcap</div>
            <input type="text" class="form-control" id="txtmarketCap" value="6770190000">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">Transactions</div>
            <input type="text" class="form-control" id="txttransactions" value="300000">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">NumberOfNodes</div>
            <input type="text" class="form-control" id="txtnumberOfNodes" value="1000">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">TokenSupply</div>
            <input type="text" class="form-control" id="txttokenSupply" value="210000000">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">Users</div>
            <input type="text" class="form-control" id="txtusers" value="100">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">TargetPrice</div>
            <input type="text" class="form-control" id="txttargetPrice" value="100">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">ChurnRate</div>
            <input type="text" class="form-control" id="txtchurnRate" value="20">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">TargetProfitabilityPerNode</div>
            <input type="text" class="form-control" id="txttargetProfitabilityPerNode" value="1000">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">EmaStickiness</div>
            <input type="text" class="form-control" id="txtemaStickiness" value="1">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">EntitlementMintPerUser</div>
            <input type="text" class="form-control" id="txtentitlementMintPerUser" value="1">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">PriceAdjustAggressiveness</div>
            <input type="text" class="form-control" id="txtpriceAdjustAggressiveness" value="100">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">MaxSupplyAdjustPercent</div>
            <input type="text" class="form-control" id="txtmaxSupplyAdjustPercent" value="2">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">MinimumNodes</div>
            <input type="text" class="form-control" id="txtminimumNodes" value="1000">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">MaxTXCost</div>
            <input type="text" class="form-control" id="txtmaxTXCost" value="100">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">MinimumBurnMintRate</div>
            <input type="text" class="form-control" id="txtminimumBurnMintRate" value="0.1">
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <div class="input-group mb-2 mr-sm-2 mb-sm-0">
            <div class="input-group-addon">Epoch</div>
            <input type="text" class="form-control" id="txtepoch" value="1">
          </div>
        </div>
      </div>
      <div class="col-md-12">
        <button id="graphdraw" class="btn btn-primary">Draw</button>
      </div>
    </div>

    <h4 class="card-title" style="margin-top: 3%; margin-bottom: 3%;">Market Capital :</h5>

    <!-- chart  -->
    <div id="my_simulationviz"></div>
      
  </hr>

  <script>
    //------------------------1. PREPARATION-------------------------//
    

    //-----------------------------simulation------------------------------//
    function seed(next) {
      next.epoch = 0;
      next.tokenPrice = next.marketCap / next.tokenSupply;


      next.tokenPriceEMA = next.tokenPrice;
      next.profitabilityPerNode = next.transactions / next.numberOfNodes * next.tokenPrice;

      next.profitabilityPerNodeEMA = next.profitabilityPerNode;

      next.joinRate = next.churnRate;

      next.mintPerTransaction = Math.min(
        Math.max(
          next.priceAdjustAggressiveness **
          (next.tokenPriceEMA - next.targetPrice),
          next.minimumBurnMintRate,
        ),
        next.tokenSupply /
        next.transactions /
        100 *
        next.maxSupplyAdjustPercent,
      );

      next.burnPerTransaction = Math.min(Math.max(next.priceAdjustAggressiveness ** -(next.tokenPriceEMA - next
          .targetPrice), next.minimumBurnMintRate, ), next.tokenSupply / next.transactions / 100 * next
        .maxSupplyAdjustPercent, next.maxTXCost, );

      next.entitlementMint = next.users * next.entitlementMintPerUser;

      return next;

    }

    /*
      Adjustments Params:
      - marketCap
      - transactions
      - users
      - targetPrice
      - churnRate
      - targetProfitabilityPerNode
      - emaStickiness
      - entitlementMintPerUser
      - priceAdjustAggressiveness
      - maxSupplyAdjustPercent
      - minimumNodes
      - maxTXCost
      - minimumBurnMintRate
    */
    function step(previous, adjustments) {

      const next = Object.assign(previous, adjustments);
      next.epoch = previous.epoch + 1;

      next.numberOfNodes = Math.max(Math.round(previous.numberOfNodes + previous.numberOfNodes * previous.joinRate /
        100 - previous.numberOfNodes * previous.churnRate / 100, ), previous.minimumNodes, );

      next.tokenSupply = previous.tokenSupply - previous.burnPerTransaction * previous.transactions + previous
        .mintPerTransaction * previous.transactions + previous.entitlementMint;

      next.tokenPrice = next.marketCap / next.tokenSupply;

      next.tokenPriceEMA = (previous.tokenPriceEMA * next.emaStickiness + previous.tokenPrice) / (next.emaStickiness +
        1);

      next.profitabilityPerNode = next.transactions / next.numberOfNodes * next.tokenPrice;

      next.profitabilityPerNodeEMA = (previous.profitabilityPerNodeEMA * next.emaStickiness + previous
        .profitabilityPerNode) / (next.emaStickiness + 1);

      next.joinRate = next.churnRate * previous.profitabilityPerNodeEMA / previous.targetProfitabilityPerNode;

      next.mintPerTransaction = Math.min(Math.max(next.priceAdjustAggressiveness ** (next.tokenPriceEMA - next
          .targetPrice), next.minimumBurnMintRate, ), next.tokenSupply / next.transactions / 100 * next
        .maxSupplyAdjustPercent, );

      next.burnPerTransaction = Math.min(Math.max(next.priceAdjustAggressiveness ** -(next.tokenPriceEMA - next
          .targetPrice), next.minimumBurnMintRate, ), next.tokenSupply / next.transactions / 100 * next
        .maxSupplyAdjustPercent, next.maxTXCost, );

      next.entitlementMint = next.users * next.entitlementMintPerUser;

      return next;

    }

    //
    // <!--- GENERATING RAW simulation RANDOMLLY -->
    // let simulations = [];

    // for (let iX = 1; iX <= 50; iX++) {
    //   //
    //   let x = Math.floor((Math.random() * 10) + (Math.random() * 5));

    //   let m = {
    //     marketCap: (1000190000 * x),
    //     epoch: iX
    //   };

    //   simulations.push(m);

    // }
    // <!--- END GENERATING RAW simulation RANDOMLLY -->

    //
    // <!-- GENERATE RAW simulation INTERVAL ->
    // 
    // setInterval(() => {
    //     current = step(current, {
    //         marketCap: current.marketCap + Math.floor(Math.random() * 10),
    //         transactions: current.transactions + Math.floor(Math.random() * 10),
    //     });
    //     simulation.push(current);
    //     console.log(current);
    // }, 1);
    //
    // <!-- END GENERATE RAW simulation INTERVAL ->

    /*
        Object:
        - epoch
        - targetPrice
        - churnRate
        - targetProfitabilityPerNode
        - emaStickiness
        - entitlementMintPerUser
        - priceAdjustAggressiveness
        - maxSupplyAdjustPercent
        - minimumNodes
        - maxTXCost
        - minimumBurnMintRate
        - marketCap
        - transactions
        - numberOfNodes
        - profitabilityPerNode
        - profitabilityPerNodeEMA
        - tokenSupply
        - tokenPrice
        - tokenPriceEMA
        - joinRate
        - mintPerTransaction
        - burnPerTransaction
        - entitlementMint
        - users
      */
      let current = seed({
        marketCap: parseInt($("#txtmarketCap").val()),
        transactions: parseInt($("#txttransactions").val()),
        numberOfNodes: parseInt($("#txtnumberOfNodes").val()),
        tokenSupply: parseInt($("#txttokenSupply").val()),
        users: parseInt($("#txtusers").val()),
        targetPrice: parseInt($("#txttargetPrice").val()),
        churnRate: parseInt($("#txtchurnRate").val()),
        targetProfitabilityPerNode: parseInt($("#txttargetProfitabilityPerNode").val()),
        emaStickiness: parseInt($("#txtemaStickiness").val()),
        entitlementMintPerUser: parseInt($("#txtentitlementMintPerUser").val()),
        priceAdjustAggressiveness: parseInt($("#txtpriceAdjustAggressiveness").val()),
        maxSupplyAdjustPercent: parseInt($("#txtmaxSupplyAdjustPercent").val()),
        minimumNodes: parseInt($("#txtminimumNodes").val()),
        maxTXCost: parseInt($("#txtmaxTXCost").val()),
        minimumBurnMintRate: parseFloat($("#txtminimumBurnMintRate").val()),
        epoch: parseInt($("#txtepoch").val())
      });

      const simulation = [Object.assign({}, current)];
        
      for (let i = 1; i < 8700; i += 1) {
        //
        current = step(current, {
          marketCap: current.marketCap + Math.floor(Math.random() * 10),
          transactions: current.transactions + Math.floor(Math.random() * 10),
        });

        // simulations.push(current);
        //
        simulation.push(Object.assign({}, current));

      }

      console.log(simulation);

    // DRAW CHART

    // set the dimensions and margins of the graph
    var margin = {top: 10, right: 30, bottom: 30, left: 60},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select("#my_simulationviz")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + ( margin.left + 20 ) + "," + margin.top + ")");

      // Add X axis --> it is a date format
    var x = d3.scaleLinear()
      .domain([0, d3.max(simulation, function(d) { return d.epoch; })])
      //.domain(d3.extent(simulation, function(d) { return d.epoch; }))
      .range([ 0, width ]);
    xAxis = svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

    // Add Y axis
    var y = d3.scaleLinear()
      //.domain([0, d3.max(simulation, function(d) { return +d.marketCap; })])
      .domain(d3.extent(simulation, function(d) { return d.marketCap; }))
      .range([ height, 0 ]);
    yAxis = svg.append("g")
      .call(d3.axisLeft(y));

    // Add a clipPath: everything out of this area won't be drawn.
    var clip = svg.append("defs").append("svg:clipPath")
        .attr("id", "clip")
        .append("svg:rect")
        .attr("width", width )
        .attr("height", height )
        .attr("x", 0)
        .attr("y", 0);

    // Add brushing
    var brush = d3.brushX()                   // Add the brush feature using the d3.brush function
        .extent( [ [0,0], [width,height] ] )  // initialise the brush area: start at 0,0 and finishes at width,height: it means I select the whole graph area
        .on("end", updateChart)               // Each time the brush selection changes, trigger the 'updateChart' function

    // Create the line variable: where both the line and the brush take place
    var line = svg.append('g')
      .attr("clip-path", "url(#clip)")

    // Add the line
    line.append("path")
      .datum(simulation)
      .attr("class", "line")  // I add the class line to be able to modify this line later on.
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(function(d) { return x(d.epoch) })
        .y(function(d) { return y(d.marketCap) })
      )

    // Add the brushing
    line
      .append("g")
        .attr("class", "brush")
        .call(brush);

    // A function that set idleTimeOut to null
    var idleTimeout
    function idled() { idleTimeout = null; }

    // A function that update the chart for given boundaries
    function updateChart() {

      // What are the selected boundaries?
      extent = d3.event.selection

      // If no selection, back to initial coordinate. Otherwise, update X axis domain
      if(!extent){
        if (!idleTimeout) return idleTimeout = setTimeout(idled, 350); // This allows to wait a little bit
        x.domain([ 4,8])
      }else{
        x.domain([ x.invert(extent[0]), x.invert(extent[1]) ])
        line.select(".brush").call(brush.move, null) // This remove the grey brush area as soon as the selection has been done
      }

      // Update axis and line position
      xAxis.transition().duration(10).call(d3.axisBottom(x))
      line
          .select('.line')
          .transition()
          .duration(1000)
          .attr("d", d3.line()
            .x(function(d) { return x(d.epoch) })
            .y(function(d) { return y(d.marketCap) })
          )
    }

    // If user double click, reinitialize the chart
    svg.on("dblclick",function(){
      x.domain(d3.extent(simulation, function(d) { return d.epoch; }))
      xAxis.transition().call(d3.axisBottom(x))
      line
        .select('.line')
        .transition()
        .attr("d", d3.line()
          .x(function(d) { return x(d.epoch) })
          .y(function(d) { return y(d.marketCap) })
      )
    });

  </script>

</body>
